<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv='Content-Type' content='text/html;charset=utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="favicon.ico">

    <title>Viewing your dataset!</title>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
          integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- Custom styles for this template -->
    <link href="styles/cover.css" rel="stylesheet">

    <link href="styles/mirror4all.css" rel="stylesheet">

    <!--link rel="stylesheet" type="text/css" href="styles/x3dom.css"/>
    <script type="text/javascript" src="scripts/x3dom-full.js"></script-->


    <link rel="stylesheet" type="text/css" href="https://x3dom.org/download/dev/x3dom.css"/>
    <script type="text/javascript" src="https://x3dom.org/download/dev/x3dom-full.js"></script>

</head>
<body>

<div class="site-wrapper">

    <div class="site-wrapper-inner">

        <div class="cover-container">

            <div class="masthead clearfix">
                <div class="inner">
                </div>
            </div>

            <div class="inner cover">
                <!--h1 class="cover-heading">Viewing</h1-->
                <div id="DropArea">
                    <div id="MyX3DPlaceHolder">

                        <X3D id="MyX3D" xmlns="http://www.x3dom.org/x3dom" showStat="false" showLog="false"
                             x="0px" y="0px" width="600px" height="600px" altImg="helloX3D-alt.png">
                            <Scene id="X3DScene">
                                <Background skyColor='0.0 0.0 0.0'></Background>
                                <Viewpoint position='0 0 10' zNear='0.0001' zFar='100'></Viewpoint>
                                <Transform id="volumeTransform">
                                    <VolumeData id='volume' dimensions='4.0 4.0 4.0'>
                                        <ImageTextureAtlas containerField='voxels' numberOfSlices='96' slicesOverX='10'
                                                           slicesOverY='10' id="voxelAtlas" hideChildren="true">
                                            <canvas width='1024' height='1024' id='voxelCanvas'></canvas>
                                        </ImageTextureAtlas>
                                        <OpacityMapVolumeStyle lightFactor='1.2' opacityFactor='6.0'>
                                            <ImageTexture containerField='transferFunction'
                                                          url='data/transfer.png'>

                                            </ImageTexture>
                                        </OpacityMapVolumeStyle>
                                    </VolumeData>
                                </Transform>
                            </Scene>
                        </X3D>
                    </div>
                </div>
            </div>

            <div class="mastfoot">
                <div class="inner">
                </div>
            </div>

        </div>
        <a class="up carousel-control" href="selection_page.html" role="button">
            <span class="glyphicon glyphicon-chevron-up" aria-hidden="true"></span>
            <span class="sr-only">Previous</span>
        </a>

    </div>

</div>

<!-- Bootstrap core JavaScript
 ================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')</script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>
<script type="text/javascript" src="scripts/dicomParser.js"></script>
<script type="text/javascript" src="scripts/cornerstone.js"></script>
<script type="text/javascript" src="scripts/cornerstoneWADOImageLoader.js"></script>
<script type="text/javascript" src="scripts/dicom2atlas.js"></script>
<script type="text/javascript" src="scripts/dat.gui.min.js"></script>

<!-- For segmentation -->
<!--script type="text/javascript" src="scripts/EmscriptenDebug.js"></script-->
<!--script type="text/javascript" src="scripts/CTThresholdSegmentationAll.js"></script-->
<!--script type="text/javascript" src="scripts/FileSaver.min.js"></script-->
<!--script type="text/javascript" src="scripts/Runner.js"></script-->

<script type="text/javascript">
    var CURRENT_FILES;

    // Prevents the drop target element from triggering default action on dropped files (download)
    function divallowdrop(event) {
        event.preventDefault();
    }

    // Handles multiple DICOM files drop on element and converts them into an atlas
    function divondrop(event) {
        // Also needed to prevent the drop target element from triggering default action on dropped files (download)
        event.stopPropagation();
        event.preventDefault();

        //Comment out to disable segmentation
        //Runner.filter.setInputFile(event.dataTransfer.files);

        // Get the number of slices info, to update the ImageTextureAtlas
        CURRENT_FILES = event.dataTransfer.files;
        var numberOfSlices = event.dataTransfer.files.length;
        var slicesOverX = Math.ceil(Math.sqrt(numberOfSlices)),
            slicesOverY = slicesOverX;

        // Reset the X3D scene declaration, and reload the scene;
        resetScene(numberOfSlices, slicesOverX, slicesOverY);

        // Resulting canvas containing atlas
        var voxelCanvas = document.getElementById("voxelCanvas");
        var voxelContext = voxelCanvas.getContext("2d");

        //Now process the dropped files with dicomParser
        filesToAtlas(event.dataTransfer.files, voxelContext, voxelCanvas.width, voxelCanvas.height, document.getElementById("InvisibleDiv"));
    }

    /*
     * Reset all the scene declaration and reload
     */
    function resetScene(numberOfSlices, slicesOverX, slicesOverY) {
        var myX3D = document.getElementById("MyX3D");
        var myX3DPlaceHolder = document.getElementById("MyX3DPlaceHolder");
        //var ORIGINAL_X3DNODE_HTML = myX3DPlaceHolder.innerHTML;// NOTE: If we get it here everything goes black!
        myX3D.parentNode.removeChild(myX3D);
        // Replace original numberOfSlices/slicesOverX/slicesOverY CURRENT_TF_VALUES with current ones
        myX3DPlaceHolder.innerHTML = ORIGINAL_X3DNODE_HTML
            .replace(/numberOfSlices=.[\d]*./i, "numberOfSlices='" + numberOfSlices + "'")
            .replace(/slicesOverX=.[\d]*./i, "slicesOverX='" + slicesOverX + "'")
            .replace(/slicesOverY=.[\d]*./i, "slicesOverY='" + slicesOverY + "'");
        // Force reload of scene
        x3dom.reload();
    }

    function updateWL(value) {
        if (CURRENT_FILES !== undefined) {
            var voxelCanvas = document.getElementById("voxelCanvas");
            var voxelContext = voxelCanvas.getContext("2d");
            filesToAtlas(CURRENT_FILES, voxelContext, voxelCanvas.width, voxelCanvas.height, document.getElementById("InvisibleDiv"), x3domcontrols.windowCenter, x3domcontrols.windowWidth);
        }
    }

    // Here we pick up the original HTML Code of our X3D Node
    var ORIGINAL_X3DNODE_HTML = document.getElementById("MyX3DPlaceHolder").innerHTML;

    function bodyonload() {
        // Set handlers for required drop events
        document.getElementById("DropArea").addEventListener("drop", divondrop);
        document.getElementById("DropArea").addEventListener("dragover", divallowdrop);

        var guiWL = new dat.GUI();
        var wlFolder = guiWL.addFolder('W/L');
        var windowCenter = wlFolder.add(x3domcontrols, 'windowCenter', -2500, 5000, 1).listen();
        var windowWidth = wlFolder.add(x3domcontrols, 'windowWidth', 0, 7500, 1).listen();
        windowCenter.onFinishChange(updateWL);
        windowWidth.onFinishChange(updateWL);
        wlFolder.open();
    }
    window.addEventListener("load", bodyonload, false);
</script>

<!-- The following div is made invisible in order to hide temporary images needed for atlas and TF computation -->
<div id="InvisibleDiv" style="display:none;background:#888888;width:50%;height:50%">
    <canvas width='256' height='10' id='tfCanvas'></canvas>
    <canvas width='256' height='10' id="tfTmpCanvas"></canvas>
    <canvas width='32' height='32' id="tmpCanvas"></canvas>
    <div id="fullHistogramHolder" style="width:512px;height:100px;display:none;">
        <canvas id="fullHistogramCanvas" width="255" height="100"></canvas>
    </div>
</div>

</body>
</html>